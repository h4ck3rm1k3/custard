#!/bin/sh
# A Munin plugin.
# See http://munin.readthedocs.org/en/latest/plugin/writing.html
# This is just a placeholder right now.

# Look for request.csv either in . or in /opt/custard
File=request.csv
test -r "$File" || cd /opt/custard

usage () {
  echo 'collect-munin [config]'
}

data () {
  # Collect the data and truncate the file.
  # We don't do this atomically, so we risk losing some data.
  # Alternatives are too horrible to contemplate.
  echo response_time.value $(
    awk -F, '{ total += $5 }; END { print total/NR }' "$File"
  )
  > "$File"
}

metadata () {
  echo graph_title Response time
  echo response_time.label Data from $(env pwd)
}

if [ $# = 0 ]
then
  data
  exit
fi

if [ $# = 1 ] && [ "$1" = config ]
then
  metadata
  exit
fi

usage >&2
exit 99
